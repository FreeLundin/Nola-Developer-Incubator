name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build-and-deploy-preview:
    name: Build and deploy preview to gh-pages/previews
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Verify npm version and upgrade if needed
        run: |
          node --version
          npm --version || true
          echo "Ensuring npm >= 10.8.3"
          npm install -g npm@10.8.3
          npm --version

      - name: Install dependencies (tolerant)
        run: npm install --no-audit --no-fund --prefer-offline

      - name: Build project
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-dist-${{ github.run_id }}
          path: ./dist/public

      - name: Comment PR with artifact and run link
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const runId = process.env.GITHUB_RUN_ID;
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const artifactName = `preview-dist-${runId}`;
            const body = `âœ… Preview build uploaded as artifact: **${artifactName}**\n\nDownload it from the Actions run page (open the link and click 'Artifacts'):\n${runUrl}\n\nIf you'd like an automatically hosted public preview URL instead, add a repository secret named \`GH_PAGES_PAT\` (a PAT with repo push permission) and I'll re-enable automatic gh-pages publishing.`;
            await github.rest.issues.createComment({ owner, repo, issue_number: context.payload.pull_request.number, body });
